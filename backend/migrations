-- Create DSI scores table for storing Digital Saturation Index calculations
CREATE TABLE IF NOT EXISTS dsi_scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pipeline_execution_id UUID NOT NULL,
    company_domain VARCHAR(255) NOT NULL,
    dsi_score FLOAT NOT NULL,
    keyword_overlap_score FLOAT NOT NULL DEFAULT 0,
    content_relevance_score FLOAT NOT NULL DEFAULT 0,
    market_presence_score FLOAT NOT NULL DEFAULT 0,
    serp_visibility_score FLOAT DEFAULT 0,
    video_engagement_score FLOAT DEFAULT 0,
    content_quality_score FLOAT DEFAULT 0,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(pipeline_execution_id, company_domain),
    CHECK (dsi_score >= 0 AND dsi_score <= 1),
    CHECK (keyword_overlap_score >= 0 AND keyword_overlap_score <= 1),
    CHECK (content_relevance_score >= 0 AND content_relevance_score <= 1),
    CHECK (market_presence_score >= 0 AND market_presence_score <= 1)
);

-- Create indexes for efficient queries
CREATE INDEX IF NOT EXISTS idx_dsi_scores_pipeline_id ON dsi_scores(pipeline_execution_id);
CREATE INDEX IF NOT EXISTS idx_dsi_scores_company ON dsi_scores(company_domain);
CREATE INDEX IF NOT EXISTS idx_dsi_scores_dsi ON dsi_scores(dsi_score DESC);
CREATE INDEX IF NOT EXISTS idx_dsi_scores_created ON dsi_scores(created_at);

-- Apply update trigger
DROP TRIGGER IF EXISTS update_dsi_scores_updated_at ON dsi_scores;
CREATE TRIGGER update_dsi_scores_updated_at
    BEFORE UPDATE ON dsi_scores
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
